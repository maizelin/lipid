<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ©º SMART Statin CDS v2.1 - å°ç£è¡€è„‚æ²»ç™‚æ±ºç­–æ”¯æ´</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@2.5.5/build/fhir-client.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; line-height: 1.6; color: #333; }
    .patient-select { margin-bottom: 20px; padding: 16px; border: 1px solid #ddd; border-radius: 12px; background: #f8f9fa; }
    select { padding: 10px; font-size: 16px; border-radius: 6px; width: 100%; max-width: 500px; margin-top: 8px;}
    .decision { color: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-height: 140px; transition: all 0.3s ease; }
    /* é¢¨éšªç­‰ç´šé¡è‰² */
    .decision.low { background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%); }
    .decision.medium { background: linear-gradient(135deg, #feca57 0%, #ff9f43 100%); }
    .decision.high { background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); }
    .decision.veryhigh { background: linear-gradient(135deg, #ff4757 0%, #c0392b 100%); border: 3px solid #b33939; }
    .decision.unknown { background: #95a5a6; } /* æœªçŸ¥é¢¨éšª */

    .status-badge { padding: 4px 12px; border-radius: 20px; font-weight: bold; background: rgba(255,255,255,0.25); }
    pre { background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 8px; max-height: 300px; overflow: auto; font-size: 13px; }
    h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; }
    .debug-banner { background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffeeba; display: none;}
  </style>
</head>
<body>
  <h1>ğŸ©º SMART Statin CDS v2.1 (å°ç£è¡€è„‚å…±è­˜ç‰ˆ)</h1>
  
  <div id="debugBanner" class="debug-banner">
    ğŸ”§ <strong>ç›®å‰ç‚º Debug/å–®æ©Ÿæ¨¡å¼</strong>ï¼šä½¿ç”¨æ¨¡æ“¬è³‡æ–™æˆ–å…¬é–‹ Sandbox é€²è¡Œæ¸¬è©¦ã€‚
  </div>
  
  <div class="patient-select" id="selectorContainer">
    <label for="patientSelect"><strong>é¸æ“‡æ¸¬è©¦å€‹æ¡ˆ (Debug æ¨¡å¼)ï¼š</strong></label><br>
    <select id="patientSelect">
      <option value="671555">å€‹æ¡ˆ A: 55æ­² ä¸€èˆ¬é¢¨éšª (LDL 130)</option>
      <option value="671561">å€‹æ¡ˆ B: 62æ­² ç³–å°¿ç—…é«˜é¢¨éšª (LDL 120)</option>
      <option value="684947">å€‹æ¡ˆ C: 68æ­² MIéå¸¸é«˜é¢¨éšª (LDL 80)</option>
      <option value="1180">å€‹æ¡ˆ D: 76æ­² é˜¿é”çˆ¾è²æ‰˜Â·å“ˆç‰¹æ›¼ (éå¸¸é«˜é¢¨éšª, ASCVD)</option>
      <option value="unknown">æœªçŸ¥å€‹æ¡ˆ (Demo default)</option>
    </select>
  </div>

  <div id="decision" class="decision unknown">
    <h3>ğŸ‘‹ æº–å‚™å°±ç·’</h3>
    <p>æ­£åœ¨ç­‰å¾…è¼‰å…¥ç—…äººæ•¸æ“š...</p>
  </div>

  <h2>ğŸ‘¤ FHIR Patient Resource</h2>
  <pre id="patient">No data loaded.</pre>

  <h2>ğŸ§ª FHIR Observation (Lipid)</h2>
  <pre id="obs">No data loaded.</pre>

  <script type="text/javascript">
    // è¨­å®š FHIR Serverï¼šè‹¥åœ¨å°ç£è¡›ç¦éƒ¨å…§ç¶²å¯æ”¹å›åŸç¶²å€
    // é€™è£¡æ”¹ç”¨å…¬é–‹çš„ SmartHealthIT R4 Sandbox ä»¥ç¢ºä¿ä»»ä½•ç¶²è·¯ç’°å¢ƒéƒ½èƒ½æ¸¬è©¦ Debug æ¨¡å¼
    const DEBUG_FHIR_SERVER = "https://launch.smarthealthit.org/v/r4/fhir";
    
    // æ¨¡æ“¬é¢¨éšªè³‡æ–™ (çœŸå¯¦ App æ‡‰è®€å– Condition Resource è‡ªå‹•è¨ˆç®—)
    const PATIENT_RISK = {
      "671555": { level: "low", name: "ä¸€èˆ¬é¢¨éšª", target: 115, desc: "SCORE é¢¨éšª < 1%" },
      "671561": { level: "high", name: "é«˜é¢¨éšª (DM)", target: 70, desc: "ç³–å°¿ç—… > 10å¹´" },
      "684947": { level: "veryhigh", name: "éå¸¸é«˜é¢¨éšª (ACS)", target: 55, desc: "æ€¥æ€§å† å¿ƒç—‡ç—…å²" },
      "1180": { level: "veryhigh", name: "éå¸¸é«˜é¢¨éšª (ASCVD)", target: 55, desc: "æ—¢æœ‰å‹•è„ˆç¡¬åŒ–æ€§å¿ƒè¡€ç®¡ç–¾ç—…" },
      "default": { level: "medium", name: "ä¸­åº¦é¢¨éšª (é è¨­)", target: 100, desc: "é¢¨éšªå› å­è©•ä¼°ä¸­" }
    };

    // 1. æå– LDL æ•¸å€¼ (å¢å¼·ç‰ˆ)
    function extractLdlValue(obsBundle) {
      if (!obsBundle || !obsBundle.entry) return null;
      // å°‹æ‰¾ç¬¦åˆ LOINC 13457-7 æˆ– 2089-1 (LDL-C) çš„è§€æ¸¬å€¼
      const ldlEntry = obsBundle.entry.find(e => {
        const codes = e.resource?.code?.coding || [];
        return codes.some(c => (c.code === "13457-7" || c.code === "2089-1"));
      });
      
      if (ldlEntry && ldlEntry.resource.valueQuantity) {
        return {
            value: ldlEntry.resource.valueQuantity.value,
            unit: ldlEntry.resource.valueQuantity.unit
        };
      }
      return null;
    }

    // 2. æ±ºç­–é‚è¼¯
    function renderDecision(patientId, ldlData) {
      const risk = PATIENT_RISK[patientId] || PATIENT_RISK["default"];
      const decisionEl = document.getElementById("decision");
      
      // è¨­å®šèƒŒæ™¯è‰²
      decisionEl.className = `decision ${risk.level}`;

      if (!ldlData) {
        decisionEl.innerHTML = `
          <h3>â“ ç¼ºä¹ LDL æ•¸æ“š</h3>
          <p>ç„¡æ³•å¾ EHR ç²å–æœ€è¿‘çš„ LDL-C æª¢é©—å ±å‘Šï¼Œè«‹æ‰‹å‹•ç¢ºèªã€‚</p>
          <small>Risk Profile: ${risk.name}</small>
        `;
        return;
      }

      const ldl = ldlData.value;
      const target = risk.target;
      let statusIcon, statusMsg, actionMsg;

      if (ldl < target) {
        statusIcon = "âœ…"; statusMsg = "æ§åˆ¶é”æ¨™"; actionMsg = "ç¶­æŒç›®å‰æ²»ç™‚ï¼Œå®šæœŸè¿½è¹¤ã€‚";
      } else if (ldl < target * 1.2) {
        statusIcon = "âš ï¸"; statusMsg = "æœªé”æ¨™ (é‚Šç·£)"; actionMsg = "å»ºè­°å¼·åŒ–ç”Ÿæ´»å‹æ…‹èª¿æ•´ï¼Œæˆ–è€ƒæ…®å¢åŠ  Statin åŠ‘é‡ã€‚";
      } else {
        statusIcon = "ğŸš¨"; statusMsg = "æ²»ç™‚å¤±æ•— / æ¥µé«˜é¢¨éšª"; actionMsg = "<strong>å»ºè­°ç«‹å³èª¿æ•´è—¥ç‰©</strong>ï¼šå¢åŠ  Statin å¼·åº¦æˆ–åˆä½µ Ezetimibeã€‚";
      }

      decisionEl.innerHTML = `
        <div style="font-size:2em; margin-bottom:10px;">${statusIcon} LDL-C: ${ldl} <span style="font-size:0.5em">${ldlData.unit}</span></div>
        <div style="margin-bottom:15px;">
           <span class="status-badge">${risk.name}</span> 
           ç›®æ¨™å€¼ < ${target} mg/dL
        </div>
        <div style="background:rgba(0,0,0,0.1); padding:15px; border-radius:8px;">
          <strong>ğŸ’¡ è‡¨åºŠå»ºè­°ï¼š</strong> ${actionMsg}
        </div>
      `;
    }

    // 3. é€šç”¨è¼‰å…¥å‡½å¼
    async function loadData(client, patientId) {
        try {
            document.getElementById("decision").innerHTML = "â³ è®€å–è³‡æ–™ä¸­...";
            
            // ä¸‹è¼‰ç—…äººè³‡æ–™
            const pt = await client.request(`Patient/${patientId}`);
            document.getElementById("patient").textContent = JSON.stringify(pt, null, 2);

            // ä¸‹è¼‰æª¢é©—è³‡æ–™ (æ’åºå–æœ€æ–°)
            const q = new URLSearchParams();
            q.set("patient", patientId);
            q.set("code", "http://loinc.org|13457-7,http://loinc.org|2089-1");
            q.set("_sort", "-date"); 
            
            const obs = await client.request(`Observation?${q.toString()}`);
            document.getElementById("obs").textContent = JSON.stringify(obs, null, 2);

            const ldlData = extractLdlValue(obs);
            renderDecision(patientId, ldlData);

        } catch (error) {
            document.getElementById("decision").className = "decision unknown";
            document.getElementById("decision").innerHTML = `<h3>âŒ è®€å–éŒ¯èª¤</h3><p>${error.message}</p>`;
            console.error(error);
        }
    }

    // 4. åˆå§‹åŒ–
    FHIR.oauth2.ready()
        .then(client => {
            // --- SMART æ¨¡å¼ ---
            console.log("SMART Launch Success");
            // éš±è—ä¸‹æ‹‰é¸å–®ï¼Œå› ç‚ºåœ¨ EHR ä¸­é€šå¸¸æ˜¯é‡å°ã€Œç•¶å‰ã€ç—…äºº
            document.getElementById("selectorContainer").style.display = "none";
            loadData(client, client.patient.id);
        })
        .catch(console.error) // æ•æ‰ ready éŒ¯èª¤ä½†ä¸é˜»æ“‹ UI é¡¯ç¤º
        .finally(() => {
            // --- åˆ¤æ–·æ˜¯å¦é€²å…¥ Debug æ¨¡å¼ ---
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has("code")) {
                document.getElementById("debugBanner").style.display = "block";
                const select = document.getElementById("patientSelect");
                
                // Debug ç”¨çš„ Client ç‰©ä»¶ (æ¨¡æ“¬ FHIR.js client ä»‹é¢)
                const debugClient = {
                    request: async (url) => {
                        const cleanUrl = url.split("?")[0]; 
                        const query = url.split("?")[1] || "";
                        const fullUrl = `${DEBUG_FHIR_SERVER}/${cleanUrl}?${query}`;
                        const resp = await fetch(fullUrl, { headers: { "Accept": "application/json" } });
                        if (!resp.ok) throw new Error("FHIR Server Error: " + resp.status);
                        return resp.json();
                    }
                };

                // ç¶å®šäº‹ä»¶
                select.addEventListener("change", () => loadData(debugClient, select.value));
                // é è¼‰ç¬¬ä¸€ç­†
                loadData(debugClient, select.value);
            }
        });

  </script>
</body>
</html>